version: "3.4"

## This overrides frontend on the docker-compose.yml file when running run.local.sh, this is done so the frontend local container
## can be updated in real time while editing frontend code, it only needs to be restarted when changing the env variables
services:
  # ========
  # Frontend
  # ========
  frontend:
    container_name: frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/:/frontend
    environment:
      - NEXT_PUBLIC_MINIO_URL=${FRONTEND_NEXT_PUBLIC_MINIO_URL}
      - NEXT_PRIVATE_BASE_URL=${FRONTEND_NEXT_PRIVATE_BASE_URL}
      - NEXT_PUBLIC_BASE_URL=${FRONTEND_NEXT_PUBLIC_BASE_URL}
      - NEXT_PUBLIC_AIRFLOW_URL=${FRONTEND_NEXT_PUBLIC_AIRFLOW_URL}
      - NEXT_PUBLIC_AIRFLOW_USERNAME=${FRONTEND_NEXT_PUBLIC_AIRFLOW_USERNAME}
      - NEXT_PUBLIC_AIRFLOW_PASSWORD=${FRONTEND_NEXT_PUBLIC_AIRFLOW_PASSWORD}
      - NEXT_PUBLIC_SUPERSET_URL=${FRONTEND_NEXT_PUBLIC_SUPERSET_URL}
      - NEXTAUTH_SECRET=${FRONTEND_NEXTAUTH_SECRET}
      - SUPERSET_USERNAME=${FRONTEND_SUPERSET_USERNAME}
      - SUPERSET_PASSWORD=${FRONTEND_SUPERSET_PASSWORD}
      - SUPERSET_URL=${FRONTEND_SUPERSET_URL}
      - SUPERSET_GUEST_USERNAME=${FRONTEND_SUPERSET_GUEST_USERNAME}
      - SUPERSET_GUEST_FIRSTNAME=${FRONTEND_SUPERSET_GUEST_FIRSTNAME}
      - SUPERSET_GUEST_LASTNAME=${FRONTEND_SUPERSET_GUEST_LASTNAME}
      - NEXT_HOP_UI=${FRONTEND_NEXT_HOP_UI}
    restart: always
    command: sh -c "npm run dev"

  # =======
  # Nginx
  # =======

  nginx:
    image: nginx:stable
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/certificates/:/etc/nginx/certs/
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
